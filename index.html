<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surf Spot Weather</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 97vh;
    }

    .leaflet-layer,
    .leaflet-control-zoom-in,
    .leaflet-control-zoom-out,
    .leaflet-control-attribution {
      filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
    }

    .overlay-text-bottom {
      position: absolute;
      bottom: 0%;
      left: 80px;
      transform: translate(-50%, -50%);
      font-size: 2em;
      font-weight: bold;
      color: rgb(84, 101, 255);
      background-color: rgb(252, 236, 203);
      border-radius: 20%;
      padding: 10px;
      text-shadow: 2px 2px 2px rgba(139, 139, 139, 0.8);
      z-index: 1000;
      font-family: 'Tahoma', 'sans-serif';
      font-size: 24px;
    }

    /* Wind arrow marker */
    .wind-marker {
      width: 30px;
      height: 30px;
      transform-origin: center center;
    }

    /* Popup table */
    .wind-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }

    .wind-table th,
    .wind-table td {
      font-family: 'Consolas', 'sans-serif';
      border: 1px solid #ddd;
      padding: 2px 4px;
      text-align: center;
    }

    .wind-table tr.good {
      background-color: #b2f2bb;
      /* light green */
    }

    .wind-table tr.verygood {
      background-color: #28ff45;
      /* light green */
    }

    .leaflet-popup-content-wrapper {
      background-color: rgb(252, 236, 203);
    }

    .nav-btn {
      display: inline-block;
      margin-top: 6px;
      padding: 5px 10px;
      background: rgb(252, 236, 203);
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
    }

    .spot-label {
      font-size: 8px;
      font-weight: bold;
      color: #333;
      background: rgba(252, 236, 203, 0.8);
      padding: 2px 4px;
      border-radius: 3px;
    }

    .nav-btn:hover {
      background: #91a8c0;
    }

    /* Mobile optimization */
    @media (max-width: 600px) {
      .wind-table {
        font-size: 10px;
      }

      .leaflet-popup-content {
        max-width: 250px !important;
      }
    }
  </style>
</head>

<body style="background-color:rgb(0, 0, 0)" ;>
  <div id="map"></div>
  <div class="overlay-text-bottom"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const map = L.map('map').setView([62.939, 23.184], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors, Crater Surfers'
    }).addTo(map);

    // Create custom SVG arrow marker
    function createWindIcon(direction, speed, best_dir) {

      let color = "#6e571a";
      if (speed >= 7 && direction >= best_dir[0] && direction <= best_dir[1]) color = "#00ff00";
      else if (speed >= 3 && direction >= best_dir[0] && direction <= best_dir[1]) color = "#008000";

      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"
             viewBox="0 0 24 24" style="transform: rotate(${direction}deg)">
          <polygon points="12,2 22,22 12,17 2,22" fill="${color}" />
        </svg>`;
      return L.divIcon({
        className: 'wind-marker',
        html: svg,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    // Fetch forecast from Yr.no
    async function fetchForecast(lat, lon) {
      const res = await axios.get(
        `https://api.met.no/weatherapi/locationforecast/2.0/complete?lat=${lat}&lon=${lon}`
      );
      return res.data;
    }

    // Build forecast table
    function buildForecastTable(timeseries, bestDirs) {
      const rows = timeseries.slice(0, 12).map(entry => {
        const t = entry.time;
        const finnishTime = new Date(t).toLocaleString("fi-FI", {
          timeZone: "Europe/Helsinki",
        });
        const wind = entry.data.instant.details.wind_speed;
        const gust = entry.data.instant.details.wind_speed_of_gust;
        const dir = entry.data.instant.details.wind_from_direction;
        const temperature = entry.data.instant.details.air_temperature;
        const isGood = wind >= 5 && wind < 7 && dir >= bestDirs[0] && dir <= bestDirs[1];
        const isveryGood = wind >= 7 && dir >= bestDirs[0] && dir <= bestDirs[1];
        if (isGood) {
          return `
          <tr class="${isGood ? 'good' : ''}">
            <td>${finnishTime}</td>
            <td>${wind.toFixed(1)}</td>
            <td>${gust.toFixed(1)}</td>
            <td>${Math.round(dir)}°</td>
            <td>${temperature.toFixed(1)}</td>
          </tr>`;
        }
        else {
          return `
          <tr class="${isveryGood ? 'verygood' : ''}">
            <td>${finnishTime}</td>
            <td>${wind.toFixed(1)}</td>
            <td>${gust.toFixed(1)}</td>
            <td>${Math.round(dir)}°</td>
            <td>${temperature.toFixed(1)}</td>
          </tr>`;
        }


      }).join("");
      return `
        <table class="wind-table">
          <tr><th>Time</th><th>Wind</th><th>Gust</th><th>Dir</th><th>Temp</th></tr>
          ${rows}
        </table>`;
    }

    let geoLayer;
    let spotData; // store loaded GeoJSON
    var updatestring = '<a href="https://github.com/naapurinpojat/CraterWeather/" target="_blank"><img id="scaledImage" src = "craterweather.jpg" height="100" alt="Crater Weather"/></a>';
    document.querySelector('.overlay-text-bottom').innerHTML = updatestring;
    // Function to refresh markers
    async function refreshSpots() {
      if (!spotData) return;

      if (geoLayer) {
        map.removeLayer(geoLayer);
      }

      geoLayer = L.geoJSON(spotData, {
        style: function (feature) {
          // No-surf areas = polygons
          if (feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon") {
            return {
              color: "red",
              fillColor: "red",
              fillOpacity: 0.3,
              weight: 2
            };
          }
        },
        onEachFeature: function (feature, layer) {
          if (feature.geometry.type !== "Point") {
            layer.bindPopup(`<b>No-surf area:</b> ${feature.properties.name || ""}`);
          }
        },
        pointToLayer: function (feature, latlng) {
          const marker = L.marker(latlng);
          //marker.bindTooltip(feature.properties.name, {
          //  permanent: true,
          //  direction: "right",
          //  className: "spot-label"
          //});



          fetchForecast(latlng.lat, latlng.lng).then(data => {
            const timeseries = data.properties.timeseries;
            const current = timeseries[0].data.instant.details;
            const wind = current.wind_speed;
            const dir = current.wind_from_direction;
            const temperature = current.air_temperature;
            const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${latlng.lat},${latlng.lng}`;
            const windyUrl = `https://www.windy.com/${latlng.lat}/${latlng.lng}/wind?${latlng.lat},${latlng.lng},13`;

            marker.setIcon(createWindIcon(dir, wind, feature.properties.best_wind_dir));

            const table = buildForecastTable(timeseries, feature.properties.best_wind_dir);
            marker.bindPopup(`<b>${feature.properties.name}</b><br>
                              Best wind: ${feature.properties.best_wind_dir[0]}°–${feature.properties.best_wind_dir[1]}°<br>
                              Current wind: ${wind.toFixed(1)} m/s (${Math.round(dir)}°)<br>
                              Current temperature: ${temperature.toFixed(1)} C°)<br>
                              Notes: ${feature.properties.notes}<br>
                              ${table}<br>
                              <a class="nav-btn" href="${gmapsUrl}" target="_blank"><img id="scaledImage" src = "map-map-marker-svgrepo-com.svg" height="50" alt="Crater Weather"/></a>
                              <a class="nav-btn" href="${windyUrl}" target="_blank"><img id="scaledImage" src = "cdnlogo.com_windy.svg" height="50" alt="Crater Weather"/></a>
                              `);
          });
          return marker;
        }
      }).addTo(map);
    }

    // Load spots.geojson once, then refresh every 5 min
    fetch("spots.geojson")
      .then(res => res.json())
      .then(spots => {
        spotData = spots;
        refreshSpots();
        setInterval(refreshSpots, 1000000); // every 5 min
      });
  </script>
</body>

</html>